<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Translating language about the Sustainable Development Goals">
  <meta name="author" content="OpenDataEnterprise">

  <title>Sustainable Development Goals - Translations</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uswds/1.6.8/css/uswds.min.css">
</head>

<body>
  <a class="usa-skipnav" href="#main-content">Skip to main content</a>

  <header class="usa-header usa-header-extended" role="banner">
    <div class="usa-navbar">
      <div class="usa-logo">
        <em class="usa-logo-text">
          <a href="/" title="Home" aria-label="Home">
            Sustainable Development Goals - Translations
          </a>
        </em>
      </div>
    </div>
  </header>

  <main id="main-content">
    <section class="usa-grid usa-section">
      <div class="usa-width-one-third">
        <h2>Translating the SDGs</h2>
      </div>
      <div class="usa-width-two-thirds">
        <p>This project exists to centralize translations of language related to the
           <a href="https://www.un.org/sustainabledevelopment/">Sustainable Development Goals</a>.
           Translations are available in <a href="https://opendataenterprise.github.io/sdg-translations/translations.json">JSON format</a>
           for easy use by other systems. Development and translation is ongoing on
           <a href="https://github.com/OpenDataEnterprise/sdg-translations">Github</a>.
        </p>
      </div>
    </section>

    <section class="usa-grid">
      <div>
        <label for="search-bar">Search for translations</label>
        <input id="search-bar" name="search-bar" type="text">
      </div>
      <div id="search-results">
        <p>Matching translations will appear here.</p>
      </div>
    </section>

  </main>


  <!-- modernizr or whatever for es6 -->
  <script src="https://unpkg.com/lunr/lunr.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uswds/1.6.8/js/uswds.min.js"></script>
  <script>
  async function init() {
    try {
      const data = await Promise.all([
        fetch('https://opendataenterprise.github.io/sdg-translations/translations.json')
          .then((response) => response.json()),
        fetch('https://opendataenterprise.github.io/sdg-translations/translation-context.json')
          .then((response) => response.json())
      ]);
      const languages = data[0];
      const contexts = data[1];

      // Convert the json into an array of documents for Lunr to index.
      let docs = {};
      Object.entries(languages).map(([lang, groups]) => {
        if (groups) {
          Object.entries(groups).map(([group, keys]) => {
            if (keys) {
              Object.entries(keys).map(([key, val]) => {
                // Support either objects of strings, or just strings.
                if (typeof val === 'object') {
                  Object.entries(val).map(([subkey, subval]) => {
                    const doc_key = group + ':' + key + '---' + subkey;
                    if (!docs[doc_key]) {
                      docs[doc_key] = {};
                    }
                    docs[doc_key]['key'] = doc_key;
                    docs[doc_key][lang] = subval;
                  });
                }
                else {
                  const doc_key = group + ':' + key;
                  if (!docs[doc_key]) {
                    docs[doc_key] = {};
                  }
                  docs[doc_key]['key'] = doc_key;
                  docs[doc_key][lang] = val;
                }
              });
            }
          });
        }
      });

      // Add any contextual info.
      contexts.forEach(function(context) {
        if (docs[context.key]) {
          docs[context.key]['context'] = context.context;
        }
      });

      // Set up the Lunr index.
      const idx = lunr(function() {
        this.ref('key');
        this.field('key');
        this.field('context');
        Object.keys(languages).forEach(function(lang) {
          this.field(lang);
        }, this);
        Object.values(docs).forEach(function(doc) {
          this.add(doc);
        }, this);
      });

      // Apply behavior to search input.
      const search_bar = document.getElementById('search-bar');
      const search_results = document.getElementById('search-results');
      search_bar.addEventListener('keyup', function(e) {
        if (this.value.length > 3) {
          // Escape colons since we use them in translation keys.
          const search_query = this.value.replace(":", "\\:");
          const matches = idx.search(search_query);
          let results = '<p>No translations found.</p>';
          if (matches.length) {
            results = '';
            matches.forEach(function(match) {
              results += '<pre>' + JSON.stringify(docs[match.ref], null, 2) + '</pre>';
            });
          }
          search_results.innerHTML = results;
        }
      });
    }
    catch (error) {
      console.log(error);
    }
  }

  init();

  </script>
</body>
</html>